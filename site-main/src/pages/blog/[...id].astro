---
// src/pages/blog/[...id].astro
import type { CollectionEntry } from 'astro:content'
import PostLayout from '@/layouts/BlogPost.astro'

// 1. Import PortableText and our helpers
import { PortableText } from 'astro-portabletext'
import { getSanityPosts, getHeadingsFromPortableText } from '../../lib/sanity'

export const prerender = true

export async function getStaticPaths() {
  const posts = await getSanityPosts()
  
  return posts.map((post: any) => ({
    // Use the slug for the URL param
    params: { id: post.slug }, 
    props: { post, posts }
  }))
}

// We loosen the type definition here because we are passing a "Fake" CollectionEntry
type Props = {
  post: any
  posts: any[]
}

const { post, posts } = Astro.props

// 2. Prepare data for the Layout
// Sanity stores body as an array (Portable Text), not a string.
// We calculate headings manually for the Table of Contents.
const headings = getHeadingsFromPortableText(post.body)

// Remark plugins don't run on Sanity data, so we pass an empty object
const remarkPluginFrontmatter = {}
---

<PostLayout {post} {posts} {headings} {remarkPluginFrontmatter}>
  <PortableText value={post.body} />
</PostLayout>
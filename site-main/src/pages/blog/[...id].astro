---
import PostLayout from '@/layouts/BlogPost.astro'
import { SanityBlogPost } from '../../lib/sanity'
import { getSanityPosts } from '../../lib/sanity'
import { marked } from 'marked'
import type { Tokens } from 'marked'
import markedKatex from 'marked-katex-extension'
import markedFootnote from 'marked-footnote'
import { gfmHeadingId } from 'marked-gfm-heading-id'
import { createHighlighter } from 'shiki'
import { 
  transformerNotationDiff, 
  transformerNotationHighlight, 
  transformerNotationWordHighlight 
} from '@shikijs/transformers'
import GithubSlugger from 'github-slugger'

export const prerender = true

export async function getStaticPaths() {
  const posts = await getSanityPosts()

  return posts.map((post) => ({
    params: { id: post.slug },
    props: {
      post,
      posts
    }
  }))
}

const { post, posts } = Astro.props as {
  post: SanityBlogPost
  posts: SanityBlogPost[]
}


// --- 1. SETUP SHIKI (Standard Themes) ---
// We load standard themes instead of the problematic 'css-variables'
const highlighter = await createHighlighter({
  themes: ['github-dark', 'github-light'],
  langs: ['js', 'ts', 'markdown', 'html', 'css', 'python', 'bash', 'json', 'astro', 'shell', 'diff', 'txt']
})

const renderer = {
  code(token: Tokens.Code) {
    const code = token.text
    const requestedLang = token.lang || 'plaintext'

    const language = highlighter.getLoadedLanguages().includes(requestedLang)
      ? requestedLang
      : 'plaintext'

    const html = highlighter.codeToHtml(code, {
      lang: language,
      themes: {
        light: 'github-light',
        dark: 'github-dark'
      },
      defaultColor: false,
      transformers: [
        transformerNotationDiff(),
        transformerNotationHighlight(),
        transformerNotationWordHighlight(),
        {
          name: 'add-line-classes',
          code(root) {
            const pre = root.children.find(
              c => c.type === 'element' && c.tagName === 'pre'
            )
            if (pre?.type === 'element') {
              pre.properties.style = 'background-color: transparent !important;'

              const codeEl = pre.children.find(
                c => c.type === 'element' && c.tagName === 'code'
              )

              if (codeEl?.type === 'element') {
                codeEl.children.forEach(line => {
                  if (line.type === 'element' && line.tagName === 'span') {
                    line.properties.className ||= []
                    ;(line.properties.className as string[]).push('line')
                  }
                })
              }
            }
          }
        }
      ]
    })

    return `
      <figure class="astro-code relative group">
        ${html}
        <div class="language absolute text-sm text-foreground px-3 py-1 top-2 right-16 opacity-50 group-hover:opacity-0 transition-opacity uppercase">
          ${language}
        </div>
        <button class="copy absolute top-2 right-2 p-1 rounded border border-border bg-muted hover:bg-primary/10 transition-all" title="Copy code">
          <span class="ready">…</span>
          <span class="success hidden">…</span>
        </button>
      </figure>
    `
  }
}


// --- 2. SETUP MARKED ---
marked.use({ renderer })
marked.use(markedKatex({ throwOnError: false }))
marked.use(gfmHeadingId())
marked.use(markedFootnote())

const htmlContent = marked.parse(post.body || '')

// --- 3. FIX TOC ---
function extractHeadings(markdown: string) {
  const slugger = new GithubSlugger()
  return marked.lexer(markdown)
    .filter((token) => token.type === 'heading')
    .map((token: any) => ({
      depth: token.depth,
      text: token.text,
      slug: slugger.slug(token.text)
    }))
}

const headings = extractHeadings(post.body || '')
---

<PostLayout 
  {post} 
  {posts} 
  {headings} 
  remarkPluginFrontmatter={{ minutesRead: post.data.minutesRead }}
>
  <article class="prose prose-pure dark:prose-invert max-w-none">
    <div set:html={htmlContent} />
  </article>
</PostLayout>